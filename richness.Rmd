---
title: "R Notebook"
output: html_notebook
---


```{r}
source("R/common.R", local = knitr::knit_global())
library(vegan)
library(ggplot2)
library(betapart)
library(viridis)
library(scales)
library(emmeans)
library(multcompView)
```

# Load data
Sort all by plot ID

## Plots -> Cluster
```{r}
insect_plant_cluster_json = read_input_json(INSECT_PLANT_CLUSTERS)
bird_cluster_json = read_input_json(BIRD_CLUSTERS)

row_to_df = function(x) {
  tibble(
    cluster_id = as.integer(x$cluster_id),
    cluster_name = x$cluster_name,
    cluster_description = x$cluster_description,
    habitat_description_from_photos = x$habitat_description_from_photos,
    representative_plot_image = x$representative_plot_image
  )
}

insect_plant_clusters = map_dfr(insect_plant_cluster_json, row_to_df)
insect_plant_clusters
```
```{r}
bird_clusters = map_dfr(bird_cluster_json, row_to_df)
bird_clusters
```

```{r}
plots_in_cluster = function(cluster_json, cluster_id) {
  idx = which(sapply(cluster_json, function(x) x$cluster_id) == cluster_id)
  if (length(idx) == 0) return(NULL)
  
  df = data.frame(plot_id = cluster_json[[idx]]['plots'])
  df$cluster_id = cluster_id
  df
}

plots_in_cluster_insect_plants = function(cluster_id) plots_in_cluster(insect_plant_cluster_json, cluster_id)
plots_in_cluster_birds = function(cluster_id) plots_in_cluster(bird_cluster_json, cluster_id)

plots_in_cluster_insect_plants(8)
```

```{r}
insect_plants_plots = map_dfr(0:9, plots_in_cluster_insect_plants) %>% left_join(insect_plant_clusters, by = 'cluster_id') %>% dplyr::select(plots, cluster_name) %>% arrange(plots) %>% rename(plot_id = plots, cluster_id = cluster_name)
insect_plants_plots
```

```{r}
bird_plots = map_dfr(0:9, plots_in_cluster_birds) %>% left_join(bird_clusters, by = 'cluster_id') %>% dplyr::select(plots, cluster_name) %>% arrange(plots) %>% rename(plot_id = plots, cluster_id = cluster_name)
bird_plots
```


## Presence Matrix
```{r}
insect_a_presence = read_input_csv(INSECT_PRESENCE) %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% 
  arrange(title) %>% rename(plot_id = title)

insect_b_presence = exclude_non_species(read_input_csv(INSECT_PRESENCE)) %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% 
  arrange(title) %>% 
  rename(plot_id = title)

insect_c_presence = include_grouped_taxa(read_input_csv(INSECT_PRESENCE)) %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% 
  arrange(title) %>% 
  rename(plot_id = title)

plant_presence = read_input_csv(PLANT_PRESENCE) %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% 
  arrange(title) %>% 
  rename(plot_id = title)

bird_presence = read_input_csv(BIRD_PRESENCE) %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(bird_plots$plot_id) %>% 
  arrange(title) %>% rename(plot_id = title)

bird_presence
```

# Analysis

## Alpha & gamma richness + simple beta per cluster
Compare richness (alpha, gamma, simple beta) across clusters

This gives you:
 * richness per plot (alpha)
 * total richness per cluster (gamma)
 * a simple Whittaker-style beta per cluster
 * tests of whether alpha differs between clusters

```{r}
alpha_richness_by_cluster = function(comm, meta) {
  alpha_plot = specnumber(comm)
  meta$alpha = alpha_plot
  
  meta %>%
    group_by(cluster_id) %>%
    summarise(
      mean_alpha = mean(alpha),
      sd_alpha   = sd(alpha),
      n_plots    = n(),
      .groups    = "drop"
    )
}

alpha_richness_by_cluster(insect_a_presence, insect_plants_plots)
```

```{r}
alpha_raw_anova_by_cluster = function(comm, meta) {
  alpha_plot = specnumber(comm)
  meta$alpha = alpha_plot
  
  aov(alpha ~ cluster_id, data = meta)
}

alpha_anova_by_cluster = function(comm, meta) {
  summary(alpha_raw_anova_by_cluster(comm, meta))
}

alpha_anova_by_cluster(insect_a_presence, insect_plants_plots)
```

```{r}
alpha_richness_by_cluster(bird_presence, bird_plots)
```

```{r}
gamma_richness_by_cluster = function(comm, meta) {
  comm_df = as.data.frame(comm) %>% left_join(meta, by = 'plot_id')
  species_cols = setdiff(names(comm_df), c('cluster_id', 'plot_id'))

  comm_df %>%
    dplyr::select(-plot_id) %>%
    group_by(cluster_id) %>%
    summarise(
      across(
        all_of(species_cols),
        ~ as.integer(any(.x)) 
      ),
      .groups = "drop"
    ) %>%
    mutate(
      gamma = rowSums(across(-cluster_id))
    ) %>%
    dplyr::select(cluster_id, gamma)
}

gamma_richness_by_cluster(insect_a_presence, insect_plants_plots)
```

```{r}
gamma_richness_by_cluster(bird_presence, bird_plots)
```

where:
* gamma = total species richness in the cluster (union of all plots in that cluster)
* mean_alpha = mean plot-level richness in that cluster

Equivalently:

* beta_whittaker + 1 = gamma / mean_alpha

So β₍W₎ + 1 is the ratio of cluster-level richness to average plot richness.

Increasing beta_whittaker as plots within cluster become more compositionally diverse.

OR

By what factor is the cluster’s species pool richer than its average plot, minus 1?

```{r}
richness_by_cluster = function(comm, meta)
  alpha_richness_by_cluster(comm, meta) %>%
  left_join(gamma_richness_by_cluster(comm, meta), by = "cluster_id") %>%
  mutate(
    beta_whittaker = gamma / mean_alpha - 1
  )
```

```{r}
plot_alpha_richness = function(richess_df, cld, fill_scale) {
  plot_data = richess_df %>%
    mutate(
      se_alpha   = sd_alpha / sqrt(n_plots)
    ) %>%
    left_join(cld$groups %>% tibble::rownames_to_column('cluster_id'), by = "cluster_id")
  
  ggplot(
      plot_data,
      aes(x = reorder(cluster_id, mean_alpha), y = mean_alpha)
    ) +
    geom_col(aes(fill = cluster_id), width = 0.7) +
    geom_errorbar(
      aes(ymin = mean_alpha - se_alpha,
          ymax = mean_alpha + se_alpha),
      width = 0.2
    ) +
    geom_text(
      aes(y = mean_alpha + se_alpha + 0.3, label = groups),
      size = 3
    ) +
    fill_scale +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = 'none') +
    labs(y = 'Mean Alpha Richness', x = 'Cluster')
}
```

```{r}
insect_plant_clusters_colour = append_insect_plant_palette(insect_plant_clusters %>% dplyr::select('cluster_id', 'cluster_name'))
bird_clusters_colour = append_bird_palette(bird_clusters %>% dplyr::select('cluster_id', 'cluster_name'), insect_plant_clusters_colour)
```

### Insects

**With species only**
Which set of clusters give more compositionally diverse plots for bird species?
```{r}
richness_by_cluster(insect_b_presence, bird_plots) %>% summarise(mean_bw = mean(beta_whittaker))
richness_by_cluster(insect_b_presence, insect_plants_plots) %>% summarise(mean_bw = mean(beta_whittaker))
```

```{r}
insect_b_richness = richness_by_cluster(insect_b_presence, insect_plants_plots)
insect_b_richness
```

```{r}
alpha_anova_by_cluster(insect_b_presence, insect_plants_plots)
```

Plot-level insect species richness did not differ significantly among habitat clusters (ANOVA:F=1.27, p = -0.12, DF = 402)

**Richness amongst 120 x 120 m habitat clusters**
```{r}
insect_b2_richness = richness_by_cluster(insect_b_presence, bird_plots)
insect_b2_richness
```

```{r}
alpha_anova_by_cluster(insect_b_presence, bird_plots)
```
```{r}
insect_b2_aov = alpha_raw_anova_by_cluster(insect_b_presence, bird_plots)
insect_b2_cld_alpha = tukey_groups = agricolae::HSD.test(insect_b2_aov, trt = "cluster_id")
insect_b2_cld_alpha$groups
```

```{r}
plot_alpha_richness(insect_b2_richness, insect_b2_cld_alpha, fill_scale(bird_clusters_colour))
ggsave('output/figure_om_insect_groups_120m_plots.jpg', height = 2000, width = 2000, units = 'px') 
```

**With any_butterfly, any_hoverfly, etc.**
```{r}
insect_a_richness = richness_by_cluster(insect_a_presence, insect_plants_plots)
insect_a_richness
```

```{r}
alpha_anova_by_cluster(insect_a_presence, insect_plants_plots)
```

Plot-level insect species richness did not differ significantly among habitat clusters (ANOVA:F=1.24, p = -0.27, DF = 402)

**Generic species groups**
```{r}
insect_c_richness = richness_by_cluster(insect_c_presence, insect_plants_plots)
insect_c_richness
```

```{r}
alpha_anova_by_cluster(insect_a_presence, insect_plants_plots)
```

Plot-level insect species richness did not differ significantly among habitat clusters (ANOVA:F=1.24, p = -0.27, DF = 402)

### Plants
Which set of clusters give more compositionally diverse plots for bird species?
```{r}
richness_by_cluster(plant_presence, bird_plots) %>% summarise(mean_bw = mean(beta_whittaker))
richness_by_cluster(plant_presence, insect_plants_plots) %>% summarise(mean_bw = mean(beta_whittaker))
```

**20 x 20 m Clusters**
```{r}
plant_richness = richness_by_cluster(plant_presence, insect_plants_plots)
plant_richness
```

```{r}
alpha_anova_by_cluster(plant_presence, insect_plants_plots)
```
Plot-level plant species richness significantly differed among habitat clusters (ANOVA:F=15.79, p < 0.001, DF = 402)

```{r}
plant_aov = alpha_raw_anova_by_cluster(plant_presence, insect_plants_plots)
plant_cld_alpha = agricolae::HSD.test(plant_aov, trt = "cluster_id")
plant_cld_alpha$groups
```

```{r}
plot_alpha_richness(plant_richness, plant_cld_alpha, fill_scale(insect_plant_clusters_colour))
ggsave('output/figure_om2_plant_groups.jpg', height = 2000, width = 2000, units = 'px')
```
Plant gamma richness differed strongly among habitat clusters (ANOVA: F₈,₄₀₂ = 15.79, p < 0.001), with Tukey post-hoc tests showing that impervious / hard-standing and short turf / intensively managed lawn plots supported significantly lower gamma richness than shrub–small-tree mosaic / young scrub-woodland, parkland — mature trees over grass, and mixed multi-layer woodland clusters.

**120 x 201 m Clusters**
```{r}
plant2_richness = richness_by_cluster(plant_presence, bird_plots)
plant2_richness
```

```{r}
alpha_anova_by_cluster(plant_presence, bird_plots)
```
Plot-level plant species richness significantly differed among habitat clusters (ANOVA:F=17.9, p < 0.001, DF = 402)

```{r}
plant2_aov = alpha_raw_anova_by_cluster(plant_presence, bird_plots)
plant2_cld_alpha = agricolae::HSD.test(plant2_aov, trt = "cluster_id")
plant2_cld_alpha$groups
```

```{r}
plot_alpha_richness(plant2_richness, plant2_cld_alpha, fill_scale(bird_clusters_colour))
ggsave('output/figure_om2_plant_groups_120m_plots.jpg', height = 2000, width = 2000, units = 'px')
```

## Birds
Which set of clusters give more compositionally diverse plots for bird species?
```{r}
richness_by_cluster(bird_presence, bird_plots) %>% summarise(mean_bw = mean(beta_whittaker))
richness_by_cluster(bird_presence, insect_plants_plots) %>% summarise(mean_bw = mean(beta_whittaker))
```

### 20 x 20 m Clusters
```{r}
bird2_richness = richness_by_cluster(bird_presence, insect_plants_plots)
bird2_richness
```

```{r}
alpha_anova_by_cluster(bird_presence, insect_plants_plots)
```
Plot-level bird species richness significantly differed among habitat clusters (ANOVA:F=2.02, p < = 0.42, DF = 402)

```{r}
bird2_aov = alpha_raw_anova_by_cluster(bird_presence, insect_plants_plots)
bird2_cld_alpha = tukey_groups = agricolae::HSD.test(bird2_aov, trt = "cluster_id")
bird2_cld_alpha$groups
```

### 120 x 120 m Clusters
```{r}
bird_richness = richness_by_cluster(bird_presence, bird_plots)
bird_richness
```

```{r}
alpha_anova_by_cluster(bird_presence, bird_plots)
```
Plot-level bird species richness significantly differed among habitat clusters (ANOVA:F=3.41, p < 0.001, DF = 402)

```{r}
bird_aov = alpha_raw_anova_by_cluster(bird_presence, bird_plots)
bird_cld_alpha = tukey_groups = agricolae::HSD.test(bird_aov, trt = "cluster_id")
bird_cld_alpha$groups
```

```{r}
plot_alpha_richness(bird_richness, bird_cld_alpha, fill_scale(bird_clusters_colour))
ggsave('output/figure_om2_bird_groups.jpg', height = 2000, width = 2000, units = 'px')
```
Bird alpha richness differed significantly among habitat clusters (ANOVA: F₈,₄₀₂ = 3.41, p < 0.001), with post-hoc tests indicating that impervious / hard-standing plots supported significantly lower alpha richness than shrub–small-tree mosaic / young scrub-woodland, parkland — mature trees over grass, and short turf / intensively managed lawn clusters (different Tukey group letters).

# Plot-level beta diversity & composition: dissimilarities, ordination, PERMANOVA
See how composition differs among plots and clusters (ordination, PERMANOVA, dispersion)

Here you treat community composition as multivariate and ask:
Do plots in different clusters have different species composition? How strong is that effect?

```{r}
insect_a_presence_num = read_input_csv(INSECT_PRESENCE) %>% 
  to_presence_as_num_dataframe() %>% 
  rename(plot_id=title)

insect_b_presence_num = exclude_non_species(read_input_csv(INSECT_PRESENCE)) %>% 
  to_presence_as_num_dataframe() %>% 
  arrange(title) %>% rename(plot_id = title)

insect_c_presence_num = include_grouped_taxa(read_input_csv(INSECT_PRESENCE)) %>% 
  to_presence_as_num_dataframe() %>% 
  arrange(title) %>% rename(plot_id = title)

plant_presence_num = read_input_csv(PLANT_PRESENCE) %>% 
  to_presence_as_num_dataframe() %>% 
  arrange(title) %>% rename(plot_id = title)

bird_presence_num = read_input_csv(BIRD_PRESENCE) %>% 
  to_presence_as_num_dataframe() %>% 
  arrange(title) %>% rename(plot_id = title)

bird_presence_num
```

##  Distance matrix and ordination (NMDS)
PERMANOVA: This tests whether cluster identity explains significant variation in community composition (i.e. beta diversity among plots)

```{r}
dist_jac = function(comm, exclusions = c()) {
  vegdist(comm %>% filter(!(plot_id %in% exclusions)) %>% arrange(plot_id) %>% dplyr::select(-plot_id), method = "jaccard", binary = TRUE)
}

insect_plant_clusters = append_insect_plant_palette(insect_plant_clusters)
insect_plant_cluster_palette = colour_scale(insect_plant_clusters)

bird_clusters = append_insect_plant_palette(bird_clusters)
bird_cluster_palette = colour_scale(bird_clusters)

build_exclusion_msg = function(exclusions) {
  if (length(exclusions) == 0) {
    return('No excluded sites.')
  }
  
  paste("Excluded sites =", paste(exclusions, collapse = ", "))
}

ordination = function(dist_jac, meta, colour_scale, taxa, cluster, exclusions = c()) {
  set.seed(15234)
  # NMDS on plots
  set.seed(123)
  nmds = metaMDS(dist_jac, k = 2, trymax = 100)
  
  scores_sites = scores(nmds, display = "sites")
  ord_data = cbind(meta, scores_sites)

  ggplot(ord_data, aes(x = NMDS1, y = NMDS2, colour = cluster_id)) +
    geom_point() +
    theme_minimal() +
    labs(
      title = paste("NMDS of", taxa, "species composition"),
      subtitle = build_exclusion_msg(exclusions),
      colour = "Cluster"
    ) + 
    colour_scale
}
```

### Insects

**20 x 20 m**
```{r}
insect_b_dist_jac = dist_jac(insect_b_presence_num)
insect_b_meta = insect_plants_plots %>% filter(plot_id %in% insect_b_presence_num$plot_id) %>% arrange(plot_id)
insect_b_ord = ordination(insect_b_dist_jac, insect_b_meta, insect_plant_cluster_palette, taxa = 'insect', cluster = '20 x 20 m')
insect_b_ord
```
**120 x 120 m**
```{r}
insect_b2_meta = bird_plots %>% filter(plot_id %in% insect_b_presence_num$plot_id) %>% arrange(plot_id)
insect_b2_ord = ordination(insect_b_dist_jac, insect_b2_meta, bird_cluster_palette, taxa = 'insect', cluster = '120 x 120 m')
insect_b2_ord
```

### Plants
**20 x 20 m**
```{r}
PLANT_EXCLUSIONS = c('663 6')
plant_dist_jac = dist_jac(plant_presence_num, PLANT_EXCLUSIONS)
plant_meta = insect_plants_plots %>% filter(plot_id %in% plant_presence_num$plot_id) %>% filter(!(plot_id %in% PLANT_EXCLUSIONS)) %>% arrange(plot_id)
plant_ord = ordination(plant_dist_jac, plant_meta, insect_plant_cluster_palette, taxa = 'plant', cluster = '20 x 20 m', PLANT_EXCLUSIONS)
plant_ord
```

**120 x 120 m**
```{r}
plant2_meta = bird_plots %>% filter(plot_id %in% plant_presence_num$plot_id) %>% filter(!(plot_id %in% PLANT_EXCLUSIONS)) %>% arrange(plot_id)
plant2_ord = ordination(plant_dist_jac, plant2_meta, bird_cluster_palette, taxa = 'plant', cluster = '120 x 120 m', PLANT_EXCLUSIONS)
plant2_ord
```

### Birds

**20 x 20 m**
```{r}
BIRD_EXCLUSIONS = c('875 4')

bird_dist_jac = dist_jac(bird_presence_num, BIRD_EXCLUSIONS)
bird_meta = insect_plants_plots %>% filter(plot_id %in% bird_presence_num$plot_id) %>% filter(!(plot_id %in% BIRD_EXCLUSIONS)) %>% arrange(plot_id)
bird_ord = ordination(bird_dist_jac, bird_meta, insect_plant_cluster_palette, taxa = 'bird', cluster = '20 x 20 m', BIRD_EXCLUSIONS)
bird_ord
```

**120 x 120 m**
```{r}
BIRD_EXCLUSIONS = c('875 4')

bird2_meta = bird_plots %>% filter(plot_id %in% bird_presence_num$plot_id) %>% filter(!(plot_id %in% BIRD_EXCLUSIONS)) %>% arrange(plot_id)
bird2_ord = ordination(bird_dist_jac, bird2_meta, bird_cluster_palette, taxa = 'bird', cluster = '120 x 120 m', BIRD_EXCLUSIONS)
bird2_ord
```

### Figure
```{r}
theme_text_sizes = theme(legend.title = element_text(size = 8), legend.subtitle = element_text(size = 6))

axis_text = function(required) {
  if (required) {
    return(element_text())
  } else {
    return(element_blank())
  }
}

nmds_part_theme = function(include_legend_position = T, include_y_axis = T) {
  legend_position = ifelse(include_legend_position, 'right', 'none')
  y_axis_text = axis_text(include_y_axis)
  
  theme(
    plot.title = element_text(size = 8), 
    plot.subtitle = element_text(size = 6),
    legend.position = legend_position,
    axis.title.y = y_axis_text
  )
}

legend1 = ggpubr::get_legend(insect_b_ord)
legend1 = ggpubr::get_legend(insect_b2_ord)

row1 = cowplot::plot_grid(
  insect_b_ord + nmds_part_theme(F, T),
  plant_ord + nmds_part_theme(F, F), 
  bird_ord + nmds_part_theme(F, F), 
  legend1,
  ncol = 4)

legend2 = ggpubr::get_legend(bird_ord)

row2 = cowplot::plot_grid(
  insect_b2_ord + nmds_part_theme(F, T),
  plant2_ord + nmds_part_theme(F, F), 
  bird2_ord + nmds_part_theme(F, F), 
  legend2,
  ncol = 4)

jpeg('output/figure_3_nmds.jpg', width = 2700, height = 2100, units = "px", res = 300)
cowplot::plot_grid(
  cowplot::ggdraw() + cowplot::draw_label("Clustered 20 x 20 m Habitat", size = 16),
  row1,
  cowplot::ggdraw() + cowplot::draw_label("Clustered 120 x 120 m Habitat", size = 16),
  row2,
  ncol = 1,
  rel_heights = c(1, 10, 1, 10))
dev.off()
```

### Alternative Insect Groups
```{r}
insect_a_dist_jac = dist_jac(insect_a_presence_num)
insect_a_meta = insect_plants_plots %>% filter(plot_id %in% insect_a_presence_num$plot_id) %>% arrange(plot_id)
insect_a_ord = ordination(insect_a_dist_jac, insect_a_meta, insect_plant_cluster_palette, taxa = 'insect', cluster = '20 x 20 m')
insect_a_ord
```

```{r}
insect_c_dist_jac = dist_jac(insect_c_presence_num)
insect_c_meta = insect_plants_plots %>% filter(plot_id %in% insect_c_presence_num$plot_id) %>% arrange(plot_id)
insect_c_ord = ordination(insect_c_dist_jac, insect_c_meta, insect_plant_cluster_palette, taxa = 'insect', cluster = '20 x 20 m')
insect_c_ord
```

## PERMANOVA: “Do clusters differ in composition?”
This tests whether cluster identity explains significant variation in community composition (i.e. beta diversity among plots).

### Insects
```{r}
PERMANOVA_SEED = 42432
```

**20 x 20 m**
```{r}
set.seed(PERMANOVA_SEED)
insect_b_adonis_res = adonis2(insect_b_dist_jac ~ cluster_id, data = insect_b_meta, permutations = 999)
insect_b_adonis_res
```

**120 x 120 m**
```{r}
insect_b2_dist_jac = dist_jac(insect_b_presence_num)
insect_b2_meta = bird_plots %>% filter(plot_id %in% insect_b_presence_num$plot_id) %>% arrange(plot_id)
adonis2(insect_b2_dist_jac ~ cluster_id, data = insect_b2_meta, permutations = 999)
```

### Plants
**20 x 20 m**
```{r}
set.seed(PERMANOVA_SEED)
plant_adonis_res = adonis2(plant_dist_jac ~ cluster_id, data = plant_meta, permutations = 999)
plant_adonis_res
```

**120 x 120 m**
```{r}
plant2_dist_jac = dist_jac(plant_presence_num)
plant2_meta = bird_plots %>% filter(plot_id %in% plant_presence_num$plot_id) %>% arrange(plot_id)
adonis2(plant2_dist_jac ~ cluster_id, data = plant2_meta, permutations = 999)
```

### Birds
**20 x 20 m**
```{r}
bird_dist_jac = dist_jac(bird_presence_num)
bird_meta = insect_plants_plots %>% filter(plot_id %in% bird_presence_num$plot_id) %>% arrange(plot_id)
adonis2(bird_dist_jac ~ cluster_id, data = bird_meta, permutations = 999)
```

**120 x 120 m**
```{r}
bird2_dist_jac = dist_jac(bird_presence_num)
bird2_meta = bird_plots %>% filter(plot_id %in% bird_presence_num$plot_id) %>% arrange(plot_id)
adonis2(bird2_dist_jac ~ cluster_id, data = bird2_meta, permutations = 999)
```

### Alernative insect groupings

**All Presence**
```{r}
set.seed(PERMANOVA_SEED)
insect_a_adonis_res = adonis2(insect_a_dist_jac ~ cluster_id, data = insect_a_meta, permutations = 999)
insect_a_adonis_res
```
cluster_id has a statistically significant but modest effect on insect community composition.

cluster_id explains about 6.8% of the variation in insect community composition. (R2 = 0.06754)

Yes, clusters differ in insect composition:
* The p-value (0.007) says your observed separation among clusters is unlikely to be random.

But the effect size is modest:
* R² ≈ 0.068 means cluster identity explains a small but real fraction of community variation.

**Generic Presence**
```{r}
set.seed(PERMANOVA_SEED)
insect_c_adonis_res = adonis2(insect_c_dist_jac ~ cluster_id, data = insect_c_meta, permutations = 999)
insect_c_adonis_res
```

## Beta dispersion (are some clusters more heterogeneous?)
This tells you if some clusters contain more internally variable plots than others (higher within-cluster beta).

### Insects
**20 x 20 m**
```{r}
insect_b_disp = betadisper(insect_b_dist_jac, group = insect_b_meta$cluster_id)
anova(insect_b_disp)               # do clusters differ in dispersion?
#TukeyHSD(insect_b_disp)            # pairwise comparisons
```

**120 x 120 m**
```{r}
insect_b2_disp = betadisper(insect_b2_dist_jac, group = insect_b2_meta$cluster_id)
anova(insect_b2_disp)               # do clusters differ in dispersion?
#TukeyHSD(insect_b_disp)            # pairwise comparisons
```

### Plants
**20 x 20 m**
```{r}
plant_disp = betadisper(plant_dist_jac, group = plant_meta$cluster_id)
anova(plant_disp)               # do clusters differ in dispersion?
#TukeyHSD(plant_disp)            # pairwise comparisons
```
Plant communities also showed significant differences among clusters (PERMANOVA on Jaccard dissimilarities, R² ≈ 0.069, F₈,₃₉₅ ≈ 3.65, p = 0.001). In contrast to insects, multivariate dispersion in plant composition varied significantly between clusters (PERMDISP, F₈,₃₉₅ ≈ 3.15, p ≈ 0.0018), with some vegetation clusters containing much more heterogeneous assemblages than others. This suggests that cluster identity captures both shifts in mean plant composition and differences in within-cluster beta diversity.

```{r}
plant_disp_df =
  data.frame(
    cluster_id = plant_meta$cluster_id,
    distance   = plant_disp$distances
  )

ggplot(plant_disp_df, aes(x = cluster_id, y = distance)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    x = "Cluster",
    y = "Distance to cluster centroid",
    title = "Within-cluster heterogeneity in plant composition"
  ) + theme(axis.text.x = element_text(angle = 40, vjust = 0.5, hjust=1))
```

**120 x 120 m**
```{r}
plant2_disp = betadisper(plant2_dist_jac, group = plant2_meta$cluster_id)
anova(plant2_disp)               # do clusters differ in dispersion?
#TukeyHSD(plant_disp)            # pairwise comparisons
```

### Birds
**20 x 20 m**
```{r}
bird_disp = betadisper(bird_dist_jac, group = bird_meta$cluster_id)
anova(bird_disp)               # do clusters differ in dispersion?
#TukeyHSD(bird_disp)            # pairwise comparisons
```

**120 x 120 m**
```{r}
bird2_disp = betadisper(bird2_dist_jac, group = bird2_meta$cluster_id)
anova(bird2_disp)               # do clusters differ in dispersion?
#TukeyHSD(bird_disp)            # pairwise comparisons
```

### Altnerative insect groupings
**All Presence**
```{r}
insect_a_disp = betadisper(insect_a_dist_jac, group = insect_a_meta$cluster_id)
anova(insect_a_disp)               # do clusters differ in dispersion?
#TukeyHSD(insect_a_disp)            # pairwise comparisons
```

There is no evidence that dispersion differs among clusters. 
In other words, clusters do not significantly differ in how spread out or heterogeneous their insect communities are.

So, putting this together with your earlier PERMANOVA (adonis2, p = 0.007, R² ≈ 0.068):
 * PERMANOVA says: cluster_id significantly affects composition (centroids differ).
 * betadisper ANOVA says: cluster dispersions do not differ (no cluster is more/less heterogeneous than the others in a statistically detectable way).

That’s the “good” scenario for interpreting PERMANOVA: your significant cluster_id effect is unlikely to be an artefact of unequal multivariate dispersion and more likely reflects real differences in community composition between clusters.

Insect community composition differed significantly among habitat clusters (PERMANOVA on Jaccard dissimilarities, R² ≈ 0.068, F₈,₁₇₃ ≈ 1.57, p = 0.007). Multivariate dispersion did not differ between clusters (PERMDISP, F₈,₁₇₃ ≈ 0.95, p = 0.48), indicating that clusters varied primarily in their centroid composition rather than in within-cluster heterogeneity.

**Generic Presence**
```{r}
insect_c_disp = betadisper(insect_c_dist_jac, group = insect_c_meta$cluster_id)
anova(insect_c_disp)               # do clusters differ in dispersion?
#TukeyHSD(insect_b_disp)            # pairwise comparisons
```

## Turnover between clusters: partitioning beta into turnover vs nestedness (betapart)
Quantify turnover between clusters and separate replacement vs nestedness

Here you collapse species to the cluster level and decompose beta diversity into:
* turnover (replacement of species)
* nestedness (one assemblage being a subset of another)
* overall beta

```{r}
# 3a. Collapse to cluster-level presence/absence
beta_core = function(comm, meta) {
  comm_df = as.data.frame(comm) %>% left_join(meta, by = 'plot_id')
  species_cols = setdiff(names(comm_df), c('cluster_id', 'plot_id'))

  cluster_comm = comm_df %>%
    dplyr::select(-plot_id) %>%
    group_by(cluster_id) %>%
    summarise(
      across(
        all_of(species_cols),
        ~ as.integer(any(.x)) 
      ),
      .groups = "drop"
    ) %>%
    column_to_rownames("cluster_id")

  betapart.core(cluster_comm)
}
```

```{r}
scale_fill_turnover = function(...) {
  scale_fill_viridis_c(
    option = "C",          # "viridis" option; colour-blind-friendly
    limits = c(0, 0.7),    # fixed min / max
    oob    = squish,       # clamp any values outside 0–0.7
    breaks = seq(0, 0.7, 0.1),
    name   = expression(beta[SIM]~"turnover"),
    ...
  )
}

turnover = function(beta_pair, species) {
  turnover_mat = as.matrix(beta_pair$beta.sim)
  
  turnover_df =
    as.data.frame(turnover_mat) %>%
    rownames_to_column("cluster_from") %>%
    pivot_longer(
      cols = -cluster_from,
      names_to = "cluster_to",
      values_to = "turnover"
    )
  
  ggplot(turnover_df, aes(x = cluster_from, y = cluster_to, fill = turnover)) +
    geom_tile() +
    theme_minimal() +
    scale_fill_turnover() +
    labs(
      title = paste("Pairwise", species, "turnover"),
      x = "Cluster",
      y = "Cluster",
      fill = "Turnover"
    ) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}
```

### Insects
**20 x 20m**
```{r}
insect_b_beta_core = beta_core(insect_b_presence, insect_plants_plots)

# 3b. Beta diversity partitioning
insect_b_beta_pair  = beta.pair(insect_b_beta_core)   # list of matrices
insect_b_beta_multi = beta.multi(insect_b_beta_core)  # overall metrics

insect_b_beta_multi   # overall turnover vs nestedness across all clusters
```
Turnover share ≈ 0.5407 / 0.6565 ≈ 0.82 → ~82% of beta

Nestedness share ≈ 0.1158 / 0.6565 ≈ 0.18 → ~18% of beta

Across the set of sites, overall compositional heterogeneity was high (multi-site Sørensen βSOR ≈ 0.66). Most of this beta diversity was attributable to species turnover (βSIM ≈ 0.54, ~82% of βSOR), with a smaller contribution of nestedness (βSNE ≈ 0.12, ~18%). This indicates that sites/clusters mainly differ by hosting different species, rather than simply representing poorer subsets of a common species pool.

```{r}
insect_b_turnover = turnover(insect_b_beta_pair, 'insect')
insect_b_turnover
```


**120 x 120m**
```{r}
insect_b2_beta_core = beta_core(insect_b_presence, bird_plots)

# 3b. Beta diversity partitioning
insect_b2_beta_pair  = beta.pair(insect_b2_beta_core)   # list of matrices
insect_b2_beta_multi = beta.multi(insect_b2_beta_core)  # overall metrics

insect_b2_beta_multi   # overall turnover vs nestedness across all clusters
```

 * Turnover share = βSIM / βSOR ≈ 0.5455 / 0.6861 ≈ 0.80 → ~80% of total beta diversity
 * Nestedness share = βSNE / βSOR ≈ 0.1406 / 0.6861 ≈ 0.20 → ~20% of total beta diversity
 
```{r}
insect_b2_turnover = turnover(insect_b2_beta_pair, 'insect')
insect_b2_turnover
```


#### Plants
**20 x 20 m**
```{r}
plant_beta_core = beta_core(plant_presence, insect_plants_plots)

# 3b. Beta diversity partitioning
plant_beta_pair  = beta.pair(plant_beta_core)   # list of matrices
plant_beta_multi = beta.multi(plant_beta_core)  # overall metrics

plant_beta_multi   # overall turnover vs nestedness across all clusters
```
Turnover share ≈ 0.26 / 0.405 ≈ 63%

Nestedness share ≈ 37%

Plant communities differ between clusters, but a substantial part of that difference is nestedness: some habitat clusters tend to hold richer plant assemblages, while others often look like species-poor subsets of those richer clusters. There is still clear turnover (species replacement), but nestedness is much more important for plants than it is for insects.

Ecologically: this fits a “template” story – certain clusters (e.g. woody, structurally complex, or less intensively managed) may act as species-rich cores, with other clusters sampling a subset of that flora.

```{r}
plant_turnover = turnover(plant_beta_pair, 'plant')
plant_turnover
```
Compare with plants using bird clusters

**120 x 120 m**
```{r}
plant2_beta_core = beta_core(plant_presence, bird_plots)

# 3b. Beta diversity partitioning
plant2_beta_pair  = beta.pair(plant2_beta_core)   # list of matrices
plant2_beta_multi = beta.multi(plant2_beta_core)  # overall metrics

plant2_beta_multi   # overall turnover vs nestedness across all clusters
```

Turnover is about two-thirds of total beta diversity here. 
 * Turnover (βSIM) = 0.311, Share of total βSOR: 0.311 / 0.460 ≈ 0.68 → ~68%
 * Nestedness (βSNE) = 0.149 Share of total βSOR: 0.149 / 0.460 ≈ 0.32 → ~32%

```{r}
plant2_turnover = turnover(plant2_beta_pair, 'plant')
plant2_turnover
```

### Birds
**20 x 20 m**
```{r}
bird_beta_core = beta_core(bird_presence, insect_plants_plots)

# 3b. Beta diversity partitioning
bird_beta_pair  = beta.pair(bird_beta_core)   # list of matrices
bird_beta_multi = beta.multi(bird_beta_core)  # overall metrics

bird_beta_multi   # overall turnover vs nestedness across all clusters
```

Turnover share ≈ 0.2683 / 0.4462 ≈ 0.60 → ~60% of beta

Nestedness share ≈ 0.1779 / 0.4462 ≈ 0.40 → ~40% of beta

Across these sites, overall beta diversity was moderate (multi-site Sørensen βSOR ≈ 0.45). Around 60% of this heterogeneity was due to species turnover (βSIM ≈ 0.27), while about 40% reflected nestedness (βSNE ≈ 0.18). Thus, both species replacement and richer-vs-poorer subset patterns contribute substantially to community differences, with nestedness playing a relatively larger role here than in the more turnover-dominated cases.


```{r}
bird_turnover = turnover(bird_beta_pair, 'bird')
bird_turnover
```

**120 x 120 m**
```{r}
bird2_beta_core = beta_core(bird_presence, bird_plots)

# 3b. Beta diversity partitioning
bird2_beta_pair  = beta.pair(bird2_beta_core)   # list of matrices
bird2_beta_multi = beta.multi(bird2_beta_core)  # overall metrics

bird2_beta_multi   # overall turnover vs nestedness across all clusters
```

Turnover share ≈ 0.35 / 0.452 ≈ 78%

Nestedness share ≈ 22%

Different clusters tend to support different bird assemblages (species replacement dominates), with a smaller role for nestedness – some clusters are richer than others, but most of the variation comes from species swapping between habitat types rather than simply adding/removing a subset.

```{r}
bird2_turnover = turnover(bird2_beta_pair, 'bird')
bird2_turnover
```


### Figure
```{r}
title_size = element_text(size = 10)
label_size = element_text(size = 6)
rel_widths = c(20, 10, 16)

jpeg('output/figure_4_turnover.jpg', width = 2700, height = 3200, units = "px", res = 300)
row1 = cowplot::plot_grid(
  insect_b_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.text.y = label_size, legend.position = 'none', plot.title = title_size), 
  plant_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.title.y = element_blank(), axis.text.y = element_blank(), legend.position = 'none', plot.title = title_size), 
  bird_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.title.y = element_blank(), axis.text.y = element_blank(), plot.title = title_size), 
  ncol = 3,
  rel_widths = rel_widths)
row2 = cowplot::plot_grid(
  insect_b2_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.text.y = label_size, legend.position = 'none', plot.title = title_size), 
  plant2_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.title.y = element_blank(), axis.text.y = element_blank(), legend.position = 'none', plot.title = title_size), 
  bird2_turnover + theme(axis.title.x = element_blank(), axis.text.x = label_size, axis.title.y = element_blank(), axis.text.y = element_blank(), plot.title = title_size), 
  ncol = 3,
  rel_widths = rel_widths)

cowplot::plot_grid(
  cowplot::ggdraw() + cowplot::draw_label("Clustered 20 x 20 m Habitat", size = 16),
  row1, 
  cowplot::ggdraw() + cowplot::draw_label("Clustered 120 x 120 m Habitat", size = 16),
  row2, 
  ncol = 1,
  rel_heights = c(1, 10, 1, 10))
dev.off()
```

### Other Insect Groupings
**All Presence**
```{r}
insect_a_beta_core = beta_core(insect_a_presence, insect_plants_plots)
```

```{r}
# 3b. Beta diversity partitioning
insect_a_beta_pair  = beta.pair(insect_a_beta_core)   # list of matrices
insect_a_beta_multi = beta.multi(insect_a_beta_core)  # overall metrics

insect_a_beta_multi   # overall turnover vs nestedness across all clusters
```

Turnover share ≈ 0.46 / 0.589 ≈ 78%

Nestedness share ≈ 22%

Across habitat clusters, insect beta diversity (multi-site Sørensen) was moderate to high (βₛₒᵣ ≈ 0.59). Most of this heterogeneity was attributable to species turnover (βₛᵢₘ ≈ 0.46, ~78% of βₛₒᵣ), with a smaller contribution of nestedness (βₛₙₑ ≈ 0.13, ~22% of βₛₒᵣ). This indicates that clusters differ primarily by hosting different insect species, rather than simply representing poorer or richer subsets of a common species pool.

Moderate–high beta diversity across clusters (βSOR ≈ 0.59), driven mainly by species turnover (~78% of βSOR). Clusters tend to have different insect species, rather than just richer/poorer subsets.

beta_pair gives matrices:
 * beta_pair$beta.sim – turnover component (pure replacement)
 * beta_pair$beta.sne – nestedness component
 * beta_pair$beta.sor – total Sørensen dissimilarity

This directly answers:
 * “Which cluster pairs have high species turnover (very different species)?”
 * “Which cluster pairs are more like nested subsets (high nestedness, low turnover)?”
 
```{r}
insect_a_turnover = turnover(insect_a_beta_pair, 'insect')
insect_a_turnover
```

**Generic Presence**

```{r}
insect_c_beta_core = beta_core(insect_c_presence, insect_plants_plots)

# 3b. Beta diversity partitioning
insect_c_beta_pair  = beta.pair(insect_c_beta_core)   # list of matrices
insect_c_beta_multi = beta.multi(insect_c_beta_core)  # overall metrics

insect_c_beta_multi   # overall turnover vs nestedness across all clusters
```
As proportions of total beta:

Turnover ≈ 0.46 / 0.59 ≈ 78% of total dissimilarity

Nestedness ≈ 0.13 / 0.59 ≈ 22% of total dissimilarity

So, most of the compositional differences between your groups are due to species replacement (clusters having different species) rather than one set of plots being species-poor subsets of another (nestedness).

```{r}
insect_c_turnover = turnover(insect_c_beta_pair, 'insect')
insect_c_turnover
```

