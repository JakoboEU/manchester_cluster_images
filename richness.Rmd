---
title: "R Notebook"
output: html_notebook
---


```{r}
source("R/common.R", local = knitr::knit_global())
library(vegan)
```

# Load data
Sort all by plot ID

## Plots -> Cluster
```{r}
insect_plant_cluster_json = read_input_json(INSECT_PLANT_CLUSTERS)
bird_cluster_json = read_input_json(BIRD_CLUSTERS)

row_to_df = function(x) {
  tibble(
    cluster_id = as.integer(x$cluster_id),
    cluster_name = x$cluster_name,
    cluster_description = x$cluster_description,
    habitat_description_from_photos = x$habitat_description_from_photos,
    representative_plot_image = x$representative_plot_image
  )
}

insect_plant_clusters = map_dfr(insect_plant_cluster_json, row_to_df)
insect_plant_clusters
```

```{r}
plots_in_cluster = function(cluster_json, cluster_id) {
  idx = which(sapply(cluster_json, function(x) x$cluster_id) == cluster_id)
  if (length(idx) == 0) return(NULL)
  
  df = data.frame(plot_id = cluster_json[[idx]]['plots'])
  df$cluster_id = cluster_id
  df
}

plots_in_cluster_insect_plants = function(cluster_id) plots_in_cluster(insect_plant_cluster_json, cluster_id)
plots_in_cluster_birds = function(cluster_id) plots_in_cluster(bird_cluster_json, cluster_id)

plots_in_cluster_insect_plants(8)
```

```{r}
insect_plants_plots = map_dfr(0:9, plots_in_cluster_insect_plants) %>% left_join(insect_plant_clusters, by = 'cluster_id') %>% dplyr::select(plots, cluster_name) %>% arrange(plots) %>% rename(plot_id = plots, cluster_id = cluster_name)
insect_plants_plots
```

```{r}
bird_plots = map_dfr(0:9, plots_in_cluster_birds) %>% left_join(bird_clusters, by = 'cluster_id') %>% dplyr::select(plots, cluster_name) %>% arrange(plots) %>% rename(plot_id = plots, cluster_id = cluster_name)
bird_plots
```


## Presence Matrix

```{r}
insect_a_presence = read_input_csv(INSECT_PRESENCE) %>% to_presence_dataframe() %>% include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% arrange(title) %>% rename(plot_id = title)
insect_b_presence = exclude_non_species(read_input_csv(INSECT_PRESENCE)) %>% include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% to_presence_dataframe() %>% arrange(title) %>% rename(plot_id = title)
plant_presence = read_input_csv(PLANT_PRESENCE) %>% to_presence_dataframe() %>% include_sites_with_no_presence_record(insect_plants_plots$plot_id) %>% arrange(title) %>% rename(plot_id = title)
bird_presence = read_input_csv(BIRD_PRESENCE) %>% to_presence_dataframe() %>% include_sites_with_no_presence_record(bird_plots$plot_id) %>% arrange(title) %>% rename(plot_id = title)

bird_presence
```

# Analysis

## Alpha & gamma richness + simple beta per cluster
```{r}
alpha_richness_by_cluster = function(comm, meta) {
  alpha_plot = specnumber(comm)
  meta$alpha = alpha_plot
  
  meta %>%
    group_by(cluster_id) %>%
    summarise(
      mean_alpha = mean(alpha),
      sd_alpha   = sd(alpha),
      n_plots    = n(),
      .groups    = "drop"
    )
}

alpha_richness_by_cluster(insect_a_presence, insect_plants_plots)
```

```{r}
alpha_richness_by_cluster(bird_presence, bird_plots)
```

```{r}
gamma_richness_by_cluster = function(comm, meta) {
  comm_df = as.data.frame(comm) %>% left_join(meta, by = 'plot_id')
  species_cols = setdiff(names(comm_df), c('cluster_id', 'plot_id'))

  comm_df %>%
    dplyr::select(-plot_id) %>%
    group_by(cluster_id) %>%
    summarise(
      across(
        all_of(species_cols),
        ~ as.integer(any(.x)) 
      ),
      .groups = "drop"
    ) %>%
    mutate(
      gamma = rowSums(across(-cluster_id))
    ) %>%
    select(cluster_id, gamma)
}

gamma_richness_by_cluster(insect_a_presence, insect_plants_plots)
```

```{r}
gamma_richness_by_cluster(bird_presence, bird_plots)
```

where:
* gamma = total species richness in the cluster (union of all plots in that cluster)
* mean_alpha = mean plot-level richness in that cluster

Equivalently:

* beta_whittaker + 1 = gamma / mean_alpha

So β₍W₎ + 1 is the ratio of cluster-level richness to average plot richness.

Increasing beta_whittaker as plots within cluster become more compositionally diverse.

OR

By what factor is the cluster’s species pool richer than its average plot, minus 1?

```{r}
richness_by_cluster = function(comm, meta)
  alpha_richness_by_cluster(comm, meta) %>%
  left_join(gamma_richness_by_cluster(comm, meta), by = "cluster_id") %>%
  mutate(
    beta_whittaker = gamma / mean_alpha - 1
  )
```

### Insects
With any_butterfly, any_hoverfly, etc.
```{r}
richness_by_cluster(insect_a_presence, insect_plants_plots)
```

With species only
```{r}
richness_by_cluster(insect_b_presence, insect_plants_plots)
```

### Plants
```{r}
richness_by_cluster(plant_presence, insect_plants_plots)
```

### Birds
Which set of clusters give more compositionally diverse plots for bird species?
```{r}
richness_by_cluster(bird_presence, bird_plots) %>% summarise(mean_bw = mean(beta_whittaker))
richness_by_cluster(bird_presence, insect_plants_plots) %>% summarise(mean_bw = mean(beta_whittaker))
```

```{r}
richness_by_cluster(bird_presence, bird_plots)
```
