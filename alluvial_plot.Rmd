---
title: "R Notebook"
output: html_notebook
---

```{r}
source("R/common.R", local = knitr::knit_global())
library(ggplot2)
library(ggalluvial)
library(mclust)
```

# Data Prep
```{r}
insect_plant_cluster_json = read_input_json(INSECT_PLANT_CLUSTERS)
bird_cluster_json = read_input_json(BIRD_CLUSTERS)

row_to_df = function(x) {
  tibble(
    cluster_id = as.integer(x$cluster_id),
    cluster_name = x$cluster_name,
    cluster_description = x$cluster_description,
    habitat_description_from_photos = x$habitat_description_from_photos,
    representative_plot_image = x$representative_plot_image
  )
}

bird_clusters = map_dfr(bird_cluster_json, row_to_df) %>% dplyr::select(cluster_id, cluster_name)
insect_plant_clusters = map_dfr(insect_plant_cluster_json, row_to_df) %>% dplyr::select(cluster_id, cluster_name)
insect_plant_clusters
```



```{r}
plots_in_cluster = function(cluster_json, cluster_id) {
  idx = which(sapply(cluster_json, function(x) x$cluster_id) == cluster_id)
  if (length(idx) == 0) return(NULL)
  
  df = data.frame(plot_id = cluster_json[[idx]]['plots'])
  df$cluster_id = cluster_id
  df
}

plots_in_cluster_insect_plants = function(cluster_id) plots_in_cluster(insect_plant_cluster_json, cluster_id)
plots_in_cluster_birds = function(cluster_id) plots_in_cluster(bird_cluster_json, cluster_id)

plots_in_cluster_insect_plants(8)
```


```{r}
insect_plants_plots = map_dfr(0:9, plots_in_cluster_insect_plants) %>% left_join(insect_plant_clusters, by = 'cluster_id') %>% rename('plot_id' = plots)
insect_plants_plots
```

```{r}
bird_plots = map_dfr(0:9, plots_in_cluster_birds) %>% left_join(bird_clusters, by = 'cluster_id') %>% rename('plot_id' = plots)
bird_plots
```

Order clusters by NDVI
```{r}
bird_clusters = bird_plots %>% 
  left_join(read_input_csv(BIRD_PREDICTORS) %>% to_ndvi()) %>% 
  group_by(cluster_name) %>% 
  summarise(avg_ndvi = mean(ndvi)) %>%
  left_join(bird_clusters) %>%
  arrange(avg_ndvi)
bird_clusters
```

```{r}
insect_plant_clusters = insect_plants_plots %>% 
  left_join(read_input_csv(INSECT_PLANT_PREDICTORS) %>% to_ndvi()) %>% 
  group_by(cluster_name) %>% 
  summarise(avg_ndvi = mean(ndvi)) %>%
  left_join(insect_plant_clusters) %>%
  arrange(avg_ndvi)
insect_plant_clusters
```

```{r}
plots = insect_plants_plots %>% left_join(insect_plant_clusters) %>% rename('insect_plants_cluster_name' = cluster_name, 'insect_plants_ndvi' = avg_ndvi) %>% 
  dplyr::select(plot_id, insect_plants_cluster_name, insect_plants_ndvi) %>% 
  left_join(bird_plots %>% left_join(bird_clusters) %>% rename('birds_cluster_name' = cluster_name, 'birds_ndvi' = avg_ndvi) %>% dplyr::select(plot_id, birds_cluster_name, birds_ndvi)) %>%
  arrange(insect_plants_ndvi, birds_ndvi) %>%
  dplyr::select(plot_id, insect_plants_cluster_name, birds_cluster_name)
plots
```
# Plots

```{r}
# Long format for ggalluvial
plots_long =
  plots %>%
  pivot_longer(
    cols = c(insect_plants_cluster_name, birds_cluster_name),
    names_to = "scale",
    values_to = "cluster"
  ) %>%
  mutate(
    # order left–right
    scale = factor(scale,
                   levels = c("insect_plants_cluster_name", "birds_cluster_name"),
                   labels = c("20 x 20 m Cluster", "120 x 120 m Cluster")),
    # make sure cluster order is consistent and not alphabetical chaos
    cluster = factor(cluster)
  )

ggplot(
  plots_long,
  aes(
    x = scale,
    stratum = cluster,
    alluvium = plot_id,   # one flow per plot
    y = 1
  )
) +
  geom_flow(
    stat = "alluvium",
    lode.guidance = "forward",
    alpha = 0.3
  ) +
  geom_stratum(width = 0.4) +
  geom_text(
    stat = "stratum",
    aes(label = cluster),
    size = 3
  ) +
  scale_x_discrete(expand = c(0.2, 0.2)) +
  labs(
    x = NULL,
    y = "Number of plots",
    title = "Movement of plots between clusterings"
  ) +
  theme_minimal()

```

```{r}
# Count how many plots move from each cluster pair
flows =
  plots %>%
    dplyr::count(insect_plants_cluster_name, birds_cluster_name, name = "n") %>%
    left_join(insect_plant_clusters %>% dplyr::select(cluster_name, avg_ndvi) %>% rename('insect_ndvi' = avg_ndvi, 'insect_plants_cluster_name' = cluster_name)) %>%
    left_join(bird_clusters %>% dplyr::select(cluster_name, avg_ndvi) %>% rename('bird_ndvi' = avg_ndvi, 'birds_cluster_name' = cluster_name)) %>%
    arrange(insect_ndvi, bird_ndvi) %>%
    mutate(
      # left axis ordered by insect_ndvi
      insect_plants_cluster_name =
        fct_reorder(insect_plants_cluster_name, insect_ndvi),

      # right axis ordered by bird_ndvi
      birds_cluster_name =
        fct_reorder(birds_cluster_name, bird_ndvi)
    )


ggplot(flows,
       aes(
         axis1 = insect_plants_cluster_name,
         axis2 = birds_cluster_name,
         y = n
       )) +
  geom_alluvium(aes(fill = insect_plants_cluster_name),
                width = 0, alpha = 0.5) +
  geom_stratum(width = 0.5) +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2) +
  scale_x_discrete(
    limits = c("20 x 20 m Cluster", "120 x 120 m Cluster"),
    expand = c(0.05, 0.05)
  ) +
  labs(
    x = NULL,
    y = "Number of plots",
    title = "Cluster transitions (aggregated by cluster pair)",
    fill = "20 x 20 m Cluster"
  ) +
  theme_minimal() + 
  fill_scale(append_insect_plant_palette(insect_plant_clusters)) + 
  theme(legend.position = "bottom", legend.text = element_text(size = 5)) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))
ggsave('output/figure_2_plot_movement_between_clusters.jpg', width = 2500, height = 1000, units = 'px')
```

# Cluster Stability

## Global: how similar are the two partitions? (Adjusted Rand index + permutation test)

Use Adjusted Rand Index (ARI) as an overall measure of “same clustering”, then test if it’s greater than expected by chance.

```{r}
ari_obs = adjustedRandIndex(plots$insect_plants_cluster_name, plots$birds_cluster_name)
ari_obs
```

ari_obs near 1 → very similar clusterings, near 0 → no more similar than random.

```{r}
set.seed(1)
n_perm = 9999
ari_null = numeric(n_perm)

for (i in seq_len(n_perm)) {
  ari_null[i] = adjustedRandIndex(plots$insect_plants_cluster_name, sample(plots$birds_cluster_name))
}

p_val = mean(ari_null >= ari_obs)
p_val
```


## Flow matrix + χ² test + “who gains/loses?” via residuals

Build the contingency table of flows from 20x20 → 120x120 and analyse it.


```{r}
flow_table =
  plots %>%
  dplyr::count(insect_plants_cluster_name, birds_cluster_name) %>%
  tidyr::pivot_wider(
    names_from = birds_cluster_name,
    values_from = n,
    values_fill = 0
  )

flow_mat = as.matrix(flow_table[ , -1])
rownames(flow_mat) = flow_table$insect_plants_cluster_name

# Chi-squared test of independence
chi_res = chisq.test(flow_mat)

chi_res$statistic   # overall X^2
chi_res$p.value     # p-value
```

If p is small, the detailed pattern of flows is not just random mixing between k=3 and k=9 clusters.

The real magic is in the standardised residuals:
```{r}
resid_mat = chi_res$stdres  # same dimensions as flow_mat
resid_mat
```
Positive residual: more plots than expected flow from that 20x20 → 120x120 combination.

Negative residual: fewer plots than expected.

### Heatmap
```{r}
resid_df =
  as.data.frame(as.table(resid_mat)) %>%
  rename(insect_plants_cluster_name = Var1, birds_cluster_name = Var2, std_resid = Freq) %>%
  left_join(insect_plant_clusters %>% dplyr::select(cluster_name, avg_ndvi) %>% rename('insect_ndvi' = avg_ndvi, 'insect_plants_cluster_name' = cluster_name)) %>%
  left_join(bird_clusters %>% dplyr::select(cluster_name, avg_ndvi) %>% rename('bird_ndvi' = avg_ndvi, 'birds_cluster_name' = cluster_name)) %>%
  mutate(
    # left axis ordered by insect_ndvi
    insect_plants_cluster_name =
      fct_reorder(insect_plants_cluster_name, insect_ndvi),

    # right axis ordered by bird_ndvi
    birds_cluster_name =
      fct_reorder(birds_cluster_name, desc(bird_ndvi))
  )

ggplot(resid_df, aes(x = insect_plants_cluster_name, y = birds_cluster_name, fill = std_resid)) +
  geom_tile() +
  scale_fill_gradient2(mid = 0) +
  labs(x = "20 x 20 m Cluster", y = "120 x 120 m Cluster",
       fill = "Std. residual") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(title = "Transitions from 20 x 20 m habitat clusters\nto120 x 120 m habitat clusters", subtitle = "(standardised χ² residuals)")
ggsave('output/figure_on_cluster_transistions.jpg', width = 2000, height = 2000, units = 'px')
```

## Per-cluster “stability”: who keeps vs loses plots?

Here you look at whether each named cluster is stable in identity for individual plots.

First define a logical “stays the same habitat” (only works because your cluster names are the same at both scales):
```{r}
clusters =
  plots %>%
  mutate(
    same_cluster = insect_plants_cluster_name == birds_cluster_name   # TRUE/FALSE per plot
  )
```

```{r}
stab_by_cluster =
  clusters %>%
  group_by(insect_plants_cluster_name) %>%
  summarise(
    n_plots = n(),
    n_same  = sum(same_cluster),
    p_same  = n_same / n_plots
  )

stab_by_cluster
```
That gives you:

Retention rate p_same per 20x20 habitat class: proportion of plots that are still in that same habitat label at 120x120

You can add binomial CIs:
```{r}
stab_by_cluster =
  stab_by_cluster %>%
  rowwise() %>%
  mutate(
    lower = binom.test(n_same, n_plots)$conf.int[1],
    upper = binom.test(n_same, n_plots)$conf.int[2]
  ) %>%
  ungroup()
stab_by_cluster
```

```{r}
ggplot(stab_by_cluster, aes(x = insect_plants_cluster_name, y = p_same)) +
  geom_pointrange(aes(ymin = lower, ymax = upper)) +
  coord_flip() +
  labs(x = "20 x 20 m Cluster", y = "Proportion of plots with same cluster at 120 x 120 m") +
  theme_minimal()
```


